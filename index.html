<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Тир-лист видеоигр</title>
<style>
  /* --- 1. VARIABLES & RESET --- */
  :root {
    --bg-light: blanchedalmond;
    --text-light: #000;
    --bg-dark: #28292c;
    --text-dark: #fff;
    
    --card-w: 1000px;
    --card-h: 280px;
    --card-radius: 18px;
    
    --primary-color: dodgerblue;
    --primary-hover: royalblue;
    --gold: #ffd700;
    
    --bg: var(--bg-light);
    --text: var(--text-light);
  }

  body.dark { --bg: var(--bg-dark); --text: var(--text-dark); }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, sans-serif;
    transition: background 0.3s, color 0.3s;
    margin: 0;
    padding: 30px 20px;
  }

  /* --- 2. LAYOUT & HEADER --- */
  .header { text-align: center; margin-bottom: 18px; }
  .controls { display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 18px; }
  
  #grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
  
  /* Анимированный заголовок */
  .page-title {
    font-size: 2.8rem;
    font-weight: 700;
    margin-bottom: 8px;
    display: inline-block;
    user-select: none;
    color: #b5b5b5a4;
    background: linear-gradient(120deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 60%);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    animation: shine 5s linear infinite;
    transition: background 0.5s ease;
  }
  
  body:not(.dark) .page-title {
    color: rgba(140, 140, 130, 0.9);
    background: linear-gradient(120deg, rgba(210,180,140,0) 40%, rgba(33,26,26,0.9) 50%, rgba(210,180,140,0) 60%);
    -webkit-background-clip: text;
    background-size: 200% 100%;
  }

  /* --- 3. CONTROLS --- */
  
  select { font-size: 1rem; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
  .controls label { font-size: 1.2rem; font-weight: bold; user-select: none; }
  
  .search-wrapper { position: relative; display: inline-block; vertical-align: middle; }
  
  #search {
    padding: 8px 10px 8px 10px;
    padding-right: 28px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.6);
    background-color: #fff;
    color: #000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  #search:focus { outline: 2px solid var(--primary-color); outline-offset: 1px; }

  #clear-search {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    font-size: 18px; cursor: pointer; color: #888; display: none; user-select: none;
  }
  #clear-search:hover { color: red; }

  /* Кнопки */
  #compare-btn, #compare-confirm, #compare-cancel, #toggle-view {
    font-size: 1rem; padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; transition: background 0.3s;
    color: white;
  }
  #compare-btn, #toggle-view { background: var(--primary-color); }
  #compare-btn:hover, #toggle-view:hover { background: var(--primary-hover); }
  #compare-confirm { background: seagreen; display: none; }
  #compare-cancel { background: crimson; display: none; }
  #toggle-view { width: 90px; text-align: center; }

  /* Переключатель темы */
  .toggle-switch { position: fixed; top: 20px; right: 20px; width: 100px; height: 50px; z-index: 1000; }
  .switch-label { position: absolute; width: 100%; height: 45px; background-color: var(--bg-dark); border-radius: 25px; cursor: pointer; border: 3px solid var(--bg-dark); }
  .checkbox { display: none; }
  .slider { position: absolute; width: 100%; height: 100%; border-radius: 25px; transition: 0.3s; }
  .checkbox:checked ~ .slider { background-color: #d8dbe0; }
  .slider::before {
    content: ""; position: absolute; top: 10px; left: 10px; width: 25px; height: 25px;
    border-radius: 50%; box-shadow: inset 12px -4px 0px 0px #d8dbe0; background-color: var(--bg-dark); transition: 0.3s;
  }
  .checkbox:checked ~ .slider::before { transform: translateX(50px); background-color: var(--bg-dark); box-shadow: none; }

  /* Кнопка наверх */
  #scroll-to-top {
    position: fixed; bottom: -60px; right: 20px; z-index: 900;
    width: 40px; height: 40px; border: none; border-radius: 50%;
    background-color: #333; color: white; font-size: 22px; cursor: pointer;
    opacity: 0; transition: opacity 0.5s ease, bottom 0.5s ease, background-color 0.5s ease;
  }
  #scroll-to-top.visible { opacity: 0.7; bottom: 20px; }
  #scroll-to-top:hover { opacity: 1; }
  #scroll-to-top:active { transform: scale(0.9); }
  body.dark #scroll-to-top { background-color: #d8dbe0; color: #28292c; }

  /* --- 4. CARDS & GRID --- */
  .card-wrap {
    display: inline-block;
    will-change: transform; /* Важно для FLIP */
    margin: 8px;
  }

  .card {
    width: min(var(--card-w), 95vw); max-width: var(--card-w); height: var(--card-h);
    border-radius: 18px; overflow: hidden; position: relative;
    box-shadow: 0 6px 18px rgba(0,0,0,0.18); cursor: pointer;
    background-size: cover; background-position: center;
    transition: transform .16s ease, box-shadow .3s ease;
    display: flex; align-items: flex-end; padding: 18px; color: #fff;
  }
  .card:hover { transform: scale(1.03); box-shadow: 0 14px 30px rgba(0,0,0,0.28); }
  .card.selected { box-shadow: 0 6px 18px rgba(0,0,0,0.18), 0 0 0 4px var(--primary-color); }

  .card .title {
    font-size: 2rem; text-shadow: none; padding: 6px 10px; border-radius: 8px;
    background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(3px);
    font-weight: bold; user-select: none;
  }

  /* Popup */
  .popup {
    position: absolute; left: 12px; top: 12px;
    background: rgba(0,0,0,0.6); color: #fff; padding: 16px 20px;
    border-radius: 12px; font-size: 1.1rem; max-width: 300px;
    opacity: 0; transition: opacity 0.4s ease 0.06s; pointer-events: none; user-select: none;
  }
  .card:hover .popup { opacity: 1; }
  .popup div { margin: 2px 0; }
  .highlight-criterion { color: var(--gold) !important; font-weight: 700; text-shadow: 0 0 6px rgba(255,215,0,0.9); }

  /* Badge */
  .badge {
    position: absolute; right: 12px; top: 12px;
    display: flex; align-items: center; gap: 6px; line-height: 1;
    background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 12px;
    font-weight: 700; font-size: 18px; user-select: none;
  }
  .rank { color: var(--gold); font-weight: 700; }
  
  /* Responsive */
  @media (max-width: 1100px) { :root { --card-w: 820px; --card-h: 240px; } }
  @media (max-width: 700px) {
    :root { --card-w: 92vw; --card-h: 180px; }
    .card .title { font-size: 1.1rem; }
  }

  /* --- 5. GRID VIEW MODE --- */
  body.grid-view #grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
  body.grid-view .card {
    width: 100%; height: 220px; padding: 0;
    justify-content: flex-end; align-items: flex-end;
  }
  body.grid-view .card .title {
    opacity: 0; background: rgba(0,0,0,0.6); text-align: center;
    width: 100%; font-size: 1.1rem; padding: 6px;
  }
  body.grid-view .card:hover .title { opacity: 1; transition: opacity 0.3s ease; }
  body.grid-view .card .popup { display: none; }
  
  body.grid-view .badge {
    top: 8px; right: 8px; font-size: 0.95rem; padding: 6px 10px;
    background: rgba(15, 15, 15, 0.75); border-radius: 10px;
    opacity: 0; transform: translateY(-5px);
  }
  body.grid-view .card:hover .badge { opacity: 1; transform: translateY(0); transition: opacity 0.3s ease, transform 0.2s ease; }
  body.grid-view .badge::before { color: var(--gold); margin-right: 4px; }

/* --- 6. MODAL --- */
  #game-modal {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000;
  }
  #game-modal::before {
    content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.7); opacity: 0; transition: opacity 0.3s ease; will-change: opacity;
  }
  #game-modal.show { display: flex; }
  #game-modal.show::before { opacity: 1; }
  
  #game-modal .modal-content {
    position: relative;
    /* Устанавливаем дефолтный фон (если картинка не загрузится) */
    background: #1a1a1a; 
    /* Принудительно белый текст, так как фон всегда будет темной картинкой */
    color: #fff; 
    padding: 40px; border-radius: 20px; 
    max-width: 900px; width: 95%;
    box-shadow: 0 12px 25px rgba(0,0,0,0.5); font-size: 1.25rem;
    transform: scale(0.9); opacity: 0; 
    transition: transform 0.3s ease, opacity 0.3s ease;
    overflow: hidden; /* Чтобы размытый фон не вылезал за скругления */
    border: 1px solid rgba(255, 255, 255, 0.1);
    /* Переменная для картинки, будет обновляться через JS */
    --modal-bg-image: url('');
  }
  
  /* Фоновое изображение игры в модалке */
  #game-modal .modal-content::before {
    content: "";
    position: absolute;
    inset: 0;
    background-image: var(--modal-bg-image);
    background-size: cover;
    background-position: center;
    /* ЧБ фильтр + затемнение (brightness), чтобы текст читался лучше */
    filter: grayscale(100%) brightness(0.4); 
    z-index: 0;
  }

  #game-modal.show .modal-content { transform: scale(1); opacity: 1; }
  
  /* Стилизация контента внутри модалки для читаемости (Glassmorphism) */
  #game-modal h2, 
  #game-modal .criteria, 
  #modal-review {
    position: relative;
    z-index: 1; /* Поднимаем текст над фоном */
    background: rgba(255, 255, 255, 0.1); /* Легкая подложка */
    backdrop-filter: blur(10px); /* Размытие фона под текстом */
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  #game-modal h2 { 
    margin-top: 0; 
    font-size: 2.2rem; 
    text-align: center; 
    background: rgba(0, 0, 0, 0.6); /* Заголовок чуть темнее */
    display: table;
    margin-left: auto;
    margin-right: auto;
  }
  
  #game-modal .criteria {
    font-size: 1.1rem;
    line-height: 1.6;
    display: table;
    margin-left:0%;
    margin-right: auto;
  }
  
  #game-modal .close-btn { 
    position: absolute; top: 15px; right: 20px; 
    font-size: 32px; font-weight: bold; cursor: pointer; 
    z-index: 2; color: rgba(255,255,255,0.7); 
    transition: color 0.3s;
  }
  #game-modal .close-btn:hover { color: #fff; }
  
  #modal-review { 
    text-align: justify; line-height: 1.6; overflow-wrap: anywhere; font-size: 1.2rem; 
  }

  /* Compare Table Fix inside Modal */
  .compare-table-wrapper { position: relative; z-index: 1; background: rgba(0,0,0,0.7); border-radius: 12px; padding: 10px; }
  .compare-table th { background: rgba(50,50,50,0.9); color: #fff; }

  /* Compare Table */
  .compare-table-wrapper { overflow-x: auto; max-width: 90vw; }
  .compare-table { border-collapse: collapse; width: max-content; min-width: 100%; }
  .compare-table th, .compare-table td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; white-space: nowrap; }
  .compare-table th { background: var(--bg); color: var(--text); position: sticky; top: 0; }

/* New: Highlight Max Value in Compare Table */
  .compare-table .highlight-max {
    color: #38b000 !important; /* Насыщенный зеленый */
    font-weight: bold;
    background-color: rgba(56, 176, 0, 0.08); /* Легкий зеленый фон */
    transition: background-color 0.3s;
  }

  /* --- 7. ANIMATIONS --- */
  @keyframes shine {
    0% { background-position: 100%; }
    100% { background-position: -100%; }
  }

  /* --- 8. GAME SPECIFIC TWEAKS (Backgrounds) --- */
  /* List View */
  .card-wrap[data-id="cyb"] .card { background-size: 110%; }
  .card-wrap[data-id="hev"] .card { background-position: 0% 80%; }
  .card-wrap[data-id="out"] .card { background-position: 0% 10%; }
  .card-wrap[data-id="jc3"] .card { background-position: 0% 10%; }
  .card-wrap[data-id="alw2"] .card { background-position: 0% 30%; }
  .card-wrap[data-id="tlou"] .card { background-position: 0% 25%; }
  .card-wrap[data-id="re4"] .card { background-position: 0% 85%; }
  .card-wrap[data-id="lit1"] .card { background-position: 0% 85%; }
  .card-wrap[data-id="lit2"] .card { background-position: 0% 90%; }
  .card-wrap[data-id="ex33"] .card { background-position: 0% 70%; }
  .card-wrap[data-id="fc3"] .card { background-position: 0% 70%; }
  .card-wrap[data-id="str"] .card { background-position: 0% 85%; }
  .card-wrap[data-id="hk"] .card { background-position: 0% 95%; }
  .card-wrap[data-id="drg"] .card { background-position: 0% 80%; }
  .card-wrap[data-id="cp"] .card { background-position: 0% 30%; }

  /* Grid View */
  body.grid-view .card-wrap[data-id="cyb"] .card { background-size: 250%; }
  body.grid-view .card-wrap[data-id="hk"] .card { background-position: 50%; }
  body.grid-view .card-wrap[data-id="gtaV"] .card { background-position: 80%; }
  body.grid-view .card-wrap[data-id="rdr2"] .card { background-position: 20%; }
  body.grid-view .card-wrap[data-id="tlou"] .card { background-position: 20%; }
  body.grid-view .card-wrap[data-id="ex33"] .card { background-size: 250%; background-position: 50% 60%; }
  body.grid-view .card-wrap[data-id="alw2"] .card { background-position: 50%; }
  body.grid-view .card-wrap[data-id="hev"] .card { background-position: 100%; }
  body.grid-view .card-wrap[data-id="bak"] .card { background-position: 90%; }
  body.grid-view .card-wrap[data-id="lit2"] .card { background-position: 40%; }
  body.grid-view .card-wrap[data-id="atm"] .card { background-position: 102%; }
  body.grid-view .card-wrap[data-id="out"] .card { background-position: 100%; }
  body.grid-view .card-wrap[data-id="jc3"] .card { background-position: 80%; }
</style>
</head>
<body>

<div class="toggle-switch">
  <label class="switch-label">
    <input type="checkbox" class="checkbox" id="theme-toggle">
    <span class="slider"></span>
  </label>
</div>

<button id="scroll-to-top" title="Наверх">↑</button>

<div class="header">
  <div class="page-title">Тир-лист видеоигр</div>
  
  <div class="controls">
    <label>Сортировать по:
      <select id="criterion">
        <option value="rating">Общий рейтинг</option>
        <option value="story">Сюжет</option>
        <option value="graphics">Графика</option>
        <option value="gameplay">Геймплей</option>
        <option value="main_character">Главный герой</option>
        <option value="characters">Персонажи</option>
        <option value="atmosphere">Атмосфера</option>
        <option value="music">Музыка</option>
      </select>
    </label>
    
    <label>Поиск:
      <div class="search-wrapper">
        <input type="text" id="search" placeholder="Введите название игры">
        <span id="clear-search" title="Очистить">×</span>
      </div>
    </label>

    <button id="compare-btn">Сравнить</button>
    <button id="compare-confirm">✓</button>
    <button id="compare-cancel">✕</button>
    <button id="toggle-view">Список</button>
  </div>
</div>

<main>
  <div id="grid" aria-live="polite"></div>
</main>

<div id="game-modal">
  <div class="modal-content"></div>
</div>

<script>
// --- 1. DATA CONFIGURATION ---

// Игры (основные данные)
const GAMES = [
  { id: "w3", title: "Witcher 3: Wild Hunt", image: "w3.jpg", ratings: {"story":10,"graphics":9,"gameplay":9,"main_character":10,"characters":10,"atmosphere":10,"music":10,"rating":9.7} },
  { id: "rdr2", title: "Red Dead Redemption 2", image: "rdr2.jpg", ratings: {"story":9,"graphics":10,"gameplay":10,"main_character":10,"characters":10,"atmosphere":9,"music":8,"rating":9.4} },
  { id: "cyb", title: "Cyberpunk 2077", image: "cyb.jpg", ratings: {"story":10,"graphics":10,"gameplay":10,"main_character":8,"characters":9,"atmosphere":9,"music":8,"rating":9.1} },
  { id: "gtaV", title: "Grand Theft Auto V", image: "gtaV.jpg", ratings: {"story":9,"graphics":8,"gameplay":9,"main_character":9,"characters":9,"atmosphere":9,"music":9,"rating":8.9} },
  { id: "alw2", title: "Alan Wake 2", image: "alw2.jpg", ratings: {"story":10,"graphics":10,"gameplay":8,"main_character":9,"characters":9,"atmosphere":9,"music":8,"rating":9.0} },
  { id: "tlou", title: "The Last of Us Part I", image: "tlou.jpg", ratings: {"story":9,"graphics":9,"gameplay":10,"main_character":9,"characters":8,"atmosphere":9,"music":10,"rating":9.1} },
  { id: "det", title: "Detroit: Become Human", image: "det.jpg", ratings: {"story":9,"graphics":8,"gameplay":8,"main_character":8,"characters":8,"atmosphere":8,"music":10,"rating":8.4} },
  { id: "eld", title: "Elden Ring", image: "eld.jpg", ratings: {"story":8,"graphics":9,"gameplay":8,"main_character":7,"characters":8,"atmosphere":9,"music":10,"rating":8.4} },
  { id: "dsr", title: "Dead Space Remake", image: "dsr.jpg", ratings: {"story":8,"graphics":10,"gameplay":9,"main_character":8,"characters":7,"atmosphere":9,"music":7,"rating":8.3} },
  { id: "bmw", title: "Black Myth: Wukong", image: "bmw.jpg", ratings: {"story":8,"graphics":9,"gameplay":9,"main_character":8,"characters":8,"atmosphere":8,"music":8,"rating":8.3} },
  { id: "bak", title: "Batman: Arkham Knight", image: "bak.jpg", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":9,"characters":7,"atmosphere":10,"music":7,"rating":8.1} },
  { id: "hev", title: "Heavy Rain", image: "hev.jpg", ratings: {"story":10,"graphics":8,"gameplay":7,"main_character":8,"characters":8,"atmosphere":9,"music":8,"rating":8.3} },
  { id: "re4", title: "Resident Evil 4 Remake", image: "re4.jpeg", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":8,"characters":9,"atmosphere":8,"music":8,"rating":8.1} },
  { id: "d16", title: "Doom (2016)", image: "d16.jpg", ratings: {"story":7,"graphics":7,"gameplay":9,"main_character":8,"characters":7,"atmosphere":8,"music":9,"rating":7.9} },
  { id: "dete", title: "Doom Eternal", image: "dete.jpg", ratings: {"story":7,"graphics":8,"gameplay":9,"main_character":8,"characters":7,"atmosphere":8,"music":9,"rating":8.0} },
  { id: "lim", title: "Limbo", image: "lim.jpg", ratings: {"story":6,"graphics":7,"gameplay":9,"main_character":7,"characters":6,"atmosphere":10,"music":9,"rating":7.7} },
  { id: "ins", title: "Inside", image: "ins.jpg", ratings: {"story":7,"graphics":7,"gameplay":9,"main_character":7,"characters":6,"atmosphere":9,"music":7,"rating":7.4} },
  { id: "crw", title: "Thronebreaker: The Witcher Tales", image: "crw.jpg", ratings: {"story":8,"graphics":7,"gameplay":9,"main_character":7,"characters":8,"atmosphere":8,"music":9,"rating":8.0} },
  { id: "fir", title: "Firewatch", image: "fir.png", ratings: {"story":7,"graphics":7,"gameplay":8,"main_character":7,"characters":7,"atmosphere":8,"music":9,"rating":7.6} },
  { id: "swd", title: "Still Wakes the Deep", image: "swd.jpg", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":7,"characters":7,"atmosphere":9,"music":7,"rating":7.7} },
  { id: "fhr", title: "Fahrenheit: Indigo Prophecy Remastered", image: "fhr.jpg", ratings: {"story":8,"graphics":6,"gameplay":7,"main_character":7,"characters":7,"atmosphere":8,"music":7,"rating":7.1} },
  { id: "inc", title: "Inscryption", image: "inc.jpg", ratings: {"story":8,"graphics":7,"gameplay":9,"main_character":6,"characters":7,"atmosphere":8,"music":8,"rating":7.6} },
  { id: "mf2", title: "Mafia II", image: "mf2.png", ratings: {"story":8,"graphics":7,"gameplay":7,"main_character":8,"characters":7,"atmosphere":8,"music":7,"rating":7.4} },
  { id: "hss", title: "Hellblade: Senua's Sacrifice", image: "hss.jpg", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":7,"characters":7,"atmosphere":9,"music":7,"rating":7.7} },
  { id: "tlou2", title: "The Last of Us Part II", image: "tlou2.jpg", ratings: {"story":8,"graphics":9,"gameplay":10,"main_character":8,"characters":8,"atmosphere":9,"music":9,"rating":8.7} },
  { id: "PTI", title: "A Plague Tale: Innocence", image: "PTI.jpg", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":8,"characters":8,"atmosphere":8,"music":7,"rating":7.9} },
  { id: "atm", title: "Atomic Heart", image: "atm.jpg", ratings: {"story":8,"graphics":9,"gameplay":9,"main_character":7,"characters":7,"atmosphere":7,"music":7,"rating":7.7} },
  { id: "jc3", title: "Just Cause 3", image: "jc3.jpg", ratings: {"story":7,"graphics":8,"gameplay":8,"main_character":8,"characters":7,"atmosphere":7,"music":8,"rating":7.6} },
  { id: "out", title: "Outlast", image: "out.jpg", ratings: {"story":8,"graphics":7,"gameplay":8,"main_character":7,"characters":8,"atmosphere":9,"music":7,"rating":7.7} },
  { id: "out2", title: "Outlast 2", image: "out2.jpg", ratings: {"story":7,"graphics":8,"gameplay":8,"main_character":7,"characters":8,"atmosphere":10,"music":8,"rating":8.0} },
  { id: "re2", title: "Resident Evil 2 Remake", image: "re2.png", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":8,"characters":7,"atmosphere":9,"music":8,"rating":8.0} },
  { id: "rev", title: "Resident Evil Village", image: "rev.jpg", ratings: {"story":8,"graphics":8,"gameplay":8,"main_character":8,"characters":9,"atmosphere":9,"music":8,"rating":8.3} },
  { id: "reb", title: "Resident Evil 7: Biohazard", image: "reb.jpg", ratings: {"story":8,"graphics":7,"gameplay":8,"main_character":8,"characters":7,"atmosphere":10,"music":8,"rating":8.0} },
  { id: "lit1", title: "Little Nightmares", image: "lit1.jpg", ratings: {"story":8,"graphics":7,"gameplay":9,"main_character":7,"characters":8,"atmosphere":8,"music":9,"rating":8.0} },
  { id: "lit2", title: "Little Nightmares 2", image: "lit2.png", ratings: {"story":8,"graphics":8,"gameplay":9,"main_character":7,"characters":8,"atmosphere":8,"music":9,"rating":8.1} },
  { id: "ex33", title: "Clair Obscur: Expedition 33", image: "ex33.png", ratings: {"story":9,"graphics":10,"gameplay":9,"main_character":9,"characters":9,"atmosphere":8,"music":10,"rating":9.1} },
  { id: "ef", title: "What Remains of Edith Finch", image: "ef.jpg", ratings: {"story":8,"graphics":8,"gameplay":9,"main_character":8,"characters":8,"atmosphere":8,"music":8,"rating":8.1} },
  { id: "p2", title: "Portal 2", image: "p2.jpg", ratings: {"story":8,"graphics":7,"gameplay":9,"main_character":7,"characters":8,"atmosphere":8,"music":8,"rating":7.9} },
  { id: "fc3", title: "Far Cry 3", image: "fc3.jpg", ratings: {"story":7,"graphics":7,"gameplay":9,"main_character":7,"characters":8,"atmosphere":8,"music":8,"rating":7.7} },
  { id: "str", title: "Stray", image: "str.jpg", ratings: {"story":7,"graphics":8,"gameplay":8,"main_character":7,"characters":7,"atmosphere":9,"music":8,"rating":7.7} },
  { id: "hk", title: "Hollow Knight", image: "hk.jpg", ratings: {"story":8,"graphics":9,"gameplay":9,"main_character":8,"characters":9,"atmosphere":9,"music":10,"rating":8.9} },
  { id: "drg", title: "DREDGE", image: "drg.png", ratings: {"story":8,"graphics":7,"gameplay":7,"main_character":6,"characters":7,"atmosphere":10,"music":8,"rating":7.6} },
  { id: "kht", title: "Kholat", image: "kht.png", ratings: {"story":7,"graphics":7,"gameplay":7,"main_character":6,"characters":6,"atmosphere":10,"music":9,"rating":7.4} },
  { id: "aw", title: "Alan Wake", image: "aw.jpg", ratings: {"story":9,"graphics":8,"gameplay":7,"main_character":8,"characters":7,"atmosphere":10,"music":8,"rating":8.1} },
  { id: "cp", title: "The Callisto Protocol", image: "cp.jpg", ratings: {"story":8,"graphics":10,"gameplay":9,"main_character":9,"characters":7,"atmosphere":9,"music":8,"rating":8.6} },
  { id: "gow", title: "God of War", image: "gow.jpg", ratings: {"story":8,"graphics":8,"gameplay":9,"main_character":8,"characters":9,"atmosphere":8,"music":8,"rating":8.3} },
  { id: "hl2", title: "Half Life 2", image: "hl2.jpg", ratings: {"story":9,"graphics":7,"gameplay":8,"main_character":7,"characters":9,"atmosphere":9,"music":9,"rating":8.3} },
  { id: "hks", title: "Hollow Knight: Silksong", image: "hks.png", ratings: {"story":9,"graphics":9,"gameplay":10,"main_character":8,"characters":9,"atmosphere":9,"music":10,"rating":9.1} },
  { id: "lp", title: "Lies of P", image: "lp.jpg", ratings: {"story":8,"graphics":8,"gameplay":7,"main_character":7,"characters":8,"atmosphere":8,"music":8,"rating":7.7} },
];

// Отдельный объект с обзорами (так проще управлять длинным текстом)
const REVIEWS = {
  "w3": `Ведьмак 3 — это потрясающая RPG с огромным впечатляющим лором, красивым миром, 
  качественно прописанными персонажами, игра отличается сильной атмосферой и грамотно 
  подобранными саундтреками.`,
  "rdr2": `Red Dead Redemption 2 — одна из немногих игр в своем жанре, здесь можно встретить 
  глубокий сюжет, сногсшибательную картинку, живых героев и NPC и невообразимое внимание к деталям.`,
  "cyb": `Cyberpunk 2077 — игра с передовыми технологиями в направлениях графики и возможностями в 
  геймплее, здесь не получится скучать, история окунёт в себя по голову, детально проработанный 
  город скрасит десятки вечеров, а судьба персонажей шокирует любого.`,
  "tlou": `The Last of Us 1 впечатлила меня добрыми и умными героями, увлекающим геймплеем, красивой 
  графикой и запоминающимися саундтреками. Эта игра способна и испугать, и вызвать слёзы, а стелс и 
  бои здесь сделаны на высшем уровне.`,
  "alw2": `Alan Wake 2 это новый уровень в мире графики, изображение в лесу здесь сложно отличить от 
  реальности. Сюжет игры прописан старательно и нетривиально, за персонажами интересно 
  наблюдать, а на протяжении всего времени прохождения я испытывал напряжение и ожидал новые сюрпризы.`,
  "gtaV": `GTA 5 это настоящее искусство в игровой индустрии, живой мир, наполненный множеством активностей, 
  динамичный геймплей и весёлый сюжет, приятная графика и обширное количество сатиры, игра не даст скучать 
  на протяжении всего прохождения.`,
  "tlou2": `The Last of Us 2 не во всём лучше первой части, но насладиться потрясающим геймплеем здесь точно 
  получится, музыка радует уши и вписывается в игру, а графика это настоящая услада для глаз. Сюжет не лучшая часть 
  игры, но он тоже увлекательный.`,
  "det": `Detroit: Become Human — шедевр, одна из лучших кинематографичных игр, количество разветвлений в 
  сюжете здесь не даст спать спокойно, и желание посмотреть на все исходы событий будет присутствовать много дней. 
  Графика устроит любого геймера, а персонажи влюбят в себя.`,
  "eld": `Elden Ring — детище Миядзаки, убившее нервы тысяч людей по всему миру. Заслуженная игра года со 
  сложнейшим впечатляющих размеров лором, фантастической музыкой, красивым миром и легендарным геймплеем 
  соулс-лайк игр.`,
  "dsr": `Dead Space Remake — хоррор во всей его красе, которому не хватает лишь одного - пугающей музыки. 
  На мой взгляд, один из лучших ремейков всего времени, красивейшая графика, увлекательная стрельба из режущих 
  оружий, постоянное желание отрубать конечности некроморфов. Добротный сюжет.`,
  "hev": `Heavy Rain — это игра, которую я упомяну, если кто-то попросит меня назвать один из лучших сюжетов в 
  играх, мрачная атмосфера, душевные персонажи, но скверный геймплей. История этой игры точно увлечёт игрока.`,
  "rev": `Resident Evil Village — пожалуй, один из лучших резидентов настоящего времени, тягостная атмосфера, 
  разнообразные локации, множество врагов. В этой игре точно будет страшно и интересно.`,
  "bmw": `Black Myth: Wukong точно должна упоминаться в списке лучших соулс-лайк игр, здесь прикольный сюжет, 
  красивые локации и графика на Unreal Engine, боёвка быстрая и несколько отличается от других игр в том же жанре. 
  Система построения билда и скиллов порадует большинство.`,
  "bak": `Batman: Arkham Knight меня увлекла своей атмосферой, она здесь на 10/10, здесь есть любимые игроками 
  Бэтмен и Джокер, красивая, особенно для своего времени, графика, топовые драки с бандитами Аркхема.`,
  "dete": `Doom Eternal — часть легендарной серии DOOM, здесь всё тот же быстрый и динамичный геймплей, радующая 
  глаза графика, огненная музыка и рубящий всё на своём пути Палач.`,
  "crw": `Thronebreaker: The Witcher Tales — карточная игра с загадками во вселенной Ведьмака, хочется сказать, 
  что в эту игру вложили душу, интерес есть в любом сражении, а музыка очаровывает.`,
  "out2": `Outlast 2 это ещё более жуткая и мерзкая игра, чем первая часть, много мяса, беззащитный главный герой, 
  обезумевшие люди и удручающая атмосфера.`,
  "reb": `Resident Evil 7: Biohazard — страх, страдания, ужас, паника, тревожность — всё, что ощущает проходящий 
  на протяжении всей истории. Одна из самых страшных, по моему мнению, игр за всё время. Если есть хорроры, то это 
  один из них.`,
  "re4": `Resident Evil 4 Remake — отличный ремейк с красивой графикой, хорошим сюжетом и добрыми героями. 
  В игре присутствуют головоломки в стиле RE и зрелищные бои с боссами.`,
  "d16": `Doom 16 — классика. Легендарная часть великого DOOM'a, экшен-перестрелки, постоянное движение, мясник Палач 
  и отличная музыка Гордона.`,
  "PTI": `A Plague Tale: Innocence — это трогающая история брата и сестры с интересным сюжетом, события происходят в 
  средневековье во Франции, здесь придётся скрываться от инквизиции и крыс, разносящих чуму.`,
  "lim": `Limbo — эталон в жанре 2D-платформеров, спокойная, вписывающаяся в игру, музыка, приятные саунды, простое управление, 
  мягкая ЧБ-графика с глубиной размытия, пронизывающая атмосфера, простенькие, но отлично дополняющие игру головоломки. 
  Слабое место - сюжет, его здесь почти нет.`,
  "hss": `Hellblade: Senua's Sacrifice это игра, в которую нельзя играть без наушников, здесь не лучшая музыка, но божественное 
  её исполнение, эффект объёмного звучания чувствуется в любом месте, также тут необычная боёвка, присутствует множество загадок 
  и вполне неплохой сюжет.`,
  "atm": `Atomic Heart — это про роботов во время СССР, хорошо прописанный сюжет, нетривиальный сеттинг, множество необычных 
  пушек и способностей. Картинка радует глаз в любом месте, но локации здесь скудные, в основном сюжете игры однотипные и надоедающие.`,
  "out": `Outlast это в первую очередь хоррор, где можно встретить много скримеров и напряжённых моментов, он имеет крутую задумку 
  с камерой, на которую надо снимать все "странности", отличную атмосферу и неплохой сюжет.`,
  "fir": `Firewatch — это игра, проходить которую надо неспеша, наслаждаясь окружающими локациями. Она успокаивает и погружает 
  в себя, сопровождая отличной музыкой, здесь есть сюжет, лес и пожарная вышка.`,
  "swd": `Still Wakes the Deep обладает хорошей графикой и хорошим сюжетом, это survival-horror, в котором точно получится 
  испугаться и повстречать персонажей, которые хоть и мало раскрыты, но импонируют.`,
  "jc3": `Just Cause 3 — это третья часть игры про легендарного Рико Родригеза, здесь не лучший сюжет, множество однотипных баз, 
  которые нужно зачистить, но это все игровые недостатки. Сильная сторона - отличный геймплей с эпичной разрушаемостью и 
  превосходный крюк-кошка, которым пользоваться одно удовольствие.`,
  "mf2": `Mafia 2 это история про всеми известного члена мафии под именем Вито Скалетта, он связал свою жизнь с криминальной 
  деятельностью и пытается выжить со своим другом Джо. В сюжете происходит много событий, которые долго не выходят из памяти.`,
  "ins": `Inside — это потрясающий платформер с хорошим сюжетом, графикой и геймплеем, игра пронизывает своей атмосферой и 
  окружением.`,
  "inc": `Inscyption — карточный рогалик с оригинальным и интересным геймплеем, из-за которого перестать играть очень тяжело,
  здесь есть сюжет и персонажи, которые подогревают интерес к прохождению.`,
  "fhr": `Fahrenheit: Indigo Prophecy Remastered игра с хорошим сюжетом и атмосферой, здесь прописанные и импонирующие персонажи, 
  приятная музыка, но слегка устаревший геймплей.`,
  "lit1": `Little Nightmares — атмосферный платформер, где есть добротный сюжет. Графика приятная и мрачная, музыка идеально 
  вписывается в игру. Прохождение здесь будет интересным из-за неочевидных путей и врагов, которые напугают.`,
  "lit2": `Little Nightmares 2 это вторая часть превосходных "Маленьких кошмаров", здесь улучшенная графика, приятный плавный 
  геймплей и уже 2 главных героя, включая Шестую(ГГ первой части), всё те же интересные головоломки и более опасные враги.`,
  "ex33": `Clair Obscur: Expedition 33 — редкая, почти во всём идеальная игра, тут добродушные персонажи, неотразимые виды, 
  множество локаций и врагов, интересные схватки и огромное количество атак и способностей. Музыка в игре это услада 
  для ушей, а сюжет понравится большинству.`,
  "ef": `What Remains of Edith Finch это трогательная история, где субтитры ведут игрока по пути, игра сделана креативно и 
  предлагает необычный игровой процесс за своё небольшое время прохождения.`,
  "p2": `Portal 2 отличная головоломка с интересной идеей и сюжетом, можно играть как одному, так и в кооперативе, много 
  бросающих вызов уровней и загадок.`,
  "fc3": `Far Cry 3 — игра с приятной графикой и геймплеем, пусть и наполненная обилием однообразных аванпостов, которые нужно зачищать, 
  красивым миром, стелс-механиками и, конечно, легендарным антагонистом Ваасом.`,
  "str": `Stray игра в стиле киберпанк про милого котика, который остался один, он попадает в населённые роботами города и решает 
  головоломки, чтобы выбраться. В Stray встречаются опасности и испытания, эта увлекательная игра скрасит пару вечеров.`,
  "hk": `Hollow Knight — прекрасная игра про Рыцаря, который исследует руины королевства насекомых Халлоунест, 
  тайтл обладает глубоким лором и приятной музыкой, а также динамичным, в меру непростым геймплеем.`,
  "drg": `DREDGE таинственная игра, где игровой процесс заключается в ловле рыбы и последующем апгрейде корабля, здесь загадочный 
  мир, который хочется исследовать и разгадывать его загадки. На первый взгляд игра выглядит другой, но поиграв в неё, понимаешь, 
  что был не прав. К сожалению, геймплей слегка утомляет из-за своего однообразия.`,
  "kht": `Kholat — история о загадочной трагедии, произошедшей на Перевале Дятлова. В игре предстоит расследовать дело исчезновения 
  группы российских студентов в суровом зимнем климате и без казуальных подсказок. Прохождение не займёт много времени, но точно 
  успеет испугать и увлечь.`,
  "re2": `Resident Evil 2 Remake — неплохой ремейк, где Леон и Клэр пытаются сбежать из города Раккун-Сити, избегая заражённых. 
  Игра наполнена головоломками и узкими коридорами. Здесь придётся экономить ресурсы и больше прятаться от преследующих мутантов.`,
  "aw": `Alan Wake это история о писателе, который решил сделать себе отпуск и отправился на остров Брайт-Фоллс, но там встретился со 
  своими собственно написанными кошмарами. Очень атмосферная игра, но однообразный геймплей.`,
  "cp": `The Callisto Protocol это похожая на Dead Space игра с динамичной боёвкой и фотореалистичной графикой. Хоррор, который держит 
  в напряжении.`,
  "gow": `God of War преподносит историю бога Кратоса и его сына Атрея, вместе они сражаются с сильными противниками в разных мирах, 
  в игре хороший сюжет и красивые пейзажи.`,
};

const LABELS = {
  story: "Сюжет", graphics: "Графика", gameplay: "Геймплей",
  main_character: "Герой", characters: "Персонажи",
  atmosphere: "Атмосфера", music: "Музыка", rating: "Общий рейтинг"
};

const LABELS_FULL = { ...LABELS, main_character: "Главный герой" };

// --- 2. UTILITIES & STATE ---
const escapeHtml = str => String(str).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' })[m]);

let state = {
  compareMode: false,
  selectedGames: [],
  currentView: localStorage.getItem('view') || 'list'
};

const dom = {
  grid: document.getElementById('grid'),
  modal: document.getElementById('game-modal'),
  modalContent: document.querySelector('.modal-content'),
  search: document.getElementById('search'),
  clearSearch: document.getElementById('clear-search'),
  criterion: document.getElementById('criterion'),
  toggleView: document.getElementById('toggle-view'),
  buttons: {
    compare: document.getElementById('compare-btn'),
    confirm: document.getElementById('compare-confirm'),
    cancel: document.getElementById('compare-cancel')
  }
};

// --- 3. RENDERING ---
function createCardElement(game) {
  const wrap = document.createElement('div');
  wrap.className = 'card-wrap';
  wrap.dataset.id = game.id;
  for (const k in game.ratings) wrap.dataset[k] = game.ratings[k];

  const card = document.createElement('div');
  card.className = 'card';
  card.style.backgroundImage = `url(imgs/${game.image})`;
  
  card.innerHTML = `
    <div class="popup">
      ${Object.entries(game.ratings).filter(([k]) => k !== 'rating').map(([k, v]) => `<div>${LABELS[k]}: ${v}</div>`).join('')}
    </div>
    <div class="badge">${game.ratings.rating}</div>
    <div class="title">${escapeHtml(game.title)}</div>
  `;
  
  wrap.appendChild(card);
  return wrap;
}

function buildGrid() {
  dom.grid.innerHTML = '';
  GAMES.forEach(game => dom.grid.appendChild(createCardElement(game)));
  document.querySelector('.page-title').textContent = `Тир-лист видеоигр (${GAMES.length} игр)`;
  applyViewMode();
}

// --- 4. IMPROVED FLIP ANIMATION (Smooth Opacity) ---
function flipSortByCriterion(criterion) {
    const container = document.getElementById('grid');
    const items = Array.from(container.children);
    
    // Подсветка полей в popup
items.forEach(item => {
    const popup = item.querySelector('.popup');
    if (!popup) return;

    // убрать старую подсветку
    popup.querySelectorAll('div').forEach(div => div.classList.remove('highlight-criterion'));

    // найти нужное поле и выделить
    const map = {
        story: "Сюжет",
        graphics: "Графика",
        gameplay: "Геймплей",
        main_character: "Герой",
        characters: "Персонажи",
        atmosphere: "Атмосфера",
        music: "Музыка",
        rating: null // рейтинг не в popup
    };

    if (map[criterion]) {
        const target = Array.from(popup.children)
            .find(div => div.textContent.startsWith(map[criterion]));
        if (target) target.classList.add('highlight-criterion');
    }
});

    // 1. FIRST (Запоминаем начальные позиции)
    const firstRects = new Map(items.map(item => [item, item.getBoundingClientRect()]));

    // 2. Сортируем (меняем порядок в массиве)
    const sortedItems = items.slice().sort((a, b) => {
        const va = parseFloat(a.dataset[criterion] ?? 0);
        const vb = parseFloat(b.dataset[criterion] ?? 0);
        return vb - va; // Сортировка по убыванию
    });

    // 3. REORDER DOM (Меняем порядок в DOM и обновляем бейджи)
    sortedItems.forEach((item, index) => {
        container.appendChild(item);
        // Обновление бейджа с местом (index + 1)
        const badge = item.querySelector('.badge');
        if (badge) {
            // Предполагаем, что рейтинг хранится в dataset.rating
            const rating = parseFloat(item.dataset.rating) || 0;
            // Обновляем бейдж, добавляя место в списке
            badge.innerHTML = `<span class="rank"> ${rating.toFixed(1)}</span> <span class="place">#${index + 1}</span>`;
        }
    });

    // 4. LAST & INVERT (Вычисляем смещение и мгновенно сдвигаем)
    sortedItems.forEach(item => {
        const first = firstRects.get(item);
        const last = item.getBoundingClientRect();
        const dx = first.left - last.left;
        const dy = first.top - last.top;

        if (dx || dy) {
            item.style.transition = 'transform 0s, opacity 150ms ease-out, box-shadow 150ms ease'; 
            
            item.style.transform = `translate(${dx}px, ${dy}px)`;
            
            item.style.opacity = 0.5;
            item.style.boxShadow = '0 0 0 rgba(0,0,0,0.0)'; // Убираем тень при перемещении
        }
    });

    // 5. PLAY (Плавно возвращаем на место)
    requestAnimationFrame(() => {
        sortedItems.forEach(item => {
            // ВАЖНО: box-shadow и opacity также включаются в этот долгий переход для возврата к норме
            item.style.transition = 'transform 500ms cubic-bezier(0.4, 0.05, 0.45, 1.1), opacity 300ms ease-out, box-shadow 300ms ease-out';
            
            item.style.transform = ''; // Сброс смещения
            item.style.opacity = 1;     // Возврат к полной прозрачности
            item.style.boxShadow = '';  // Возврат к стандартной тени (через CSS)
        });
    });
}

// --- 5. MODAL LOGIC (Fix: Check both REVIEWS and game object) ---
function openModal(contentHTML) {
  dom.modalContent.innerHTML = `<span class="close-btn" onclick="closeModal()">×</span>` + contentHTML;
  dom.modal.style.display = 'flex';
  requestAnimationFrame(() => dom.modal.classList.add('show'));
}

function closeModal() {
  dom.modal.classList.remove('show');
  setTimeout(() => dom.modal.style.display = 'none', 300);
}

function showGameDetails(game) {
  // Передаем картинку в CSS переменную модального окна перед открытием
  dom.modalContent.style.setProperty('--modal-bg-image', `url(imgs/${game.image})`);

  const criteriaHTML = Object.entries(game.ratings)
    .filter(([k]) => k !== 'rating')
    .map(([k, v]) => `<b>${LABELS_FULL[k]}:</b> ${v}`) // Добавил жирный шрифт для названий
    .join('<br>');

  const description = REVIEWS[game.id] || game.review || "Описание скоро появится...";

  const html = `
    <h2>${escapeHtml(game.title)}</h2>
    <div class="criteria">${criteriaHTML}</div>
    <div id="modal-review">${description}</div>
  `;
  
  // При открытии обычной карточки убираем лишние стили таблицы сравнения, если они были
  dom.modalContent.classList.remove('compare-mode');
  
  openModal(html);
}

// Функция для открытия модального окна сравнения
function showCompareModal() {
  if (state.selectedGames.length < 2) return alert("Выберите хотя бы 2 игры.");
  
  // --- 1. Сброс анимационных стилей (для корректной работы модалки) ---
  dom.modalContent.style.setProperty('--modal-bg-image', 'none');
  dom.modalContent.style.transform = '';
  dom.modalContent.style.clipPath = ''; 
  dom.modalContent.classList.remove('animating', 'closing');
  // --------------------------------------------------------------------

  const keys = Object.keys(LABELS_FULL);
  
  // 2. Находим максимальные значения для каждого критерия среди выбранных игр
  const maxRatings = {};
  
  keys.forEach(key => {
    let max = -Infinity;
    state.selectedGames.forEach(game => {
      // Преобразуем рейтинг в число для сравнения
      const rating = parseFloat(game.ratings[key]) || 0; 
      if (rating > max) {
        max = rating;
      }
    });
    // Сохраняем максимальное значение, только если оно больше 0
    if (max > 0) {
       maxRatings[key] = max;
    }
  });
  
  // 3. Генерируем заголовки таблицы
  const headerRow = state.selectedGames.map(g => `<th>${escapeHtml(g.title)}</th>`).join('');
  
  // 4. Генерируем строки таблицы с выделением
  const tableRows = keys.map(k => {
    const tds = state.selectedGames.map(game => {
      const rating = game.ratings[k] || '-';
      let classNames = '';

      // Проверяем, является ли текущий рейтинг максимальным для этого критерия
      if (maxRatings[k] && parseFloat(rating) === maxRatings[k]) {
        classNames = 'highlight-max';
      }
      
      // Возвращаем ячейку с классом подсветки, если необходимо
      return `<td class="${classNames}" style="text-align:center">${rating}</td>`;
    }).join('');
    
    return `<tr><td><b>${LABELS_FULL[k]}</b></td>${tds}</tr>`;
  }).join('');
  
  // 5. Собираем HTML
  const html = `
    <h2>Сравнение игр</h2>
    <div class="compare-table-wrapper">
      <table class="compare-table">
        <tr><th>Критерий</th>${headerRow}</tr>
        ${tableRows}
      </table>
    </div>
  `;
  
  openModal(html);
  setCompareMode(false);
}

// --- 6. COMPARE & VIEW STATE ---
function setCompareMode(active) {
  state.compareMode = active;
  state.selectedGames = [];
  document.querySelectorAll('.card.selected').forEach(c => c.classList.remove('selected'));
  
  dom.buttons.compare.style.display = active ? 'none' : 'inline-block';
  dom.buttons.confirm.style.display = active ? 'inline-block' : 'none';
  dom.buttons.cancel.style.display = active ? 'inline-block' : 'none';
}

function handleCardClick(wrap) {
  const game = GAMES.find(g => g.id === wrap.dataset.id);
  if (!game) return;

  if (state.compareMode) {
    const card = wrap.querySelector('.card');
    const idx = state.selectedGames.findIndex(g => g.id === game.id);
    if (idx >= 0) {
      state.selectedGames.splice(idx, 1);
      card.classList.remove('selected');
    } else {
      state.selectedGames.push(game);
      card.classList.add('selected');
    }
  } else {
    showGameDetails(game);
  }
}

function applyViewMode() {
  const isGrid = state.currentView === 'grid';
  document.body.classList.toggle('grid-view', isGrid);
  dom.toggleView.textContent = isGrid ? "Сетка" : "Список";
  localStorage.setItem('view', state.currentView);
}

// --- 7. LISTENERS ---
dom.grid.addEventListener('click', e => {
  const wrap = e.target.closest('.card-wrap');
  if (wrap) handleCardClick(wrap);
});

dom.criterion.addEventListener('change', e => flipSortByCriterion(e.target.value));

dom.search.addEventListener('input', function() {
  const query = this.value.trim().toLowerCase();
  dom.clearSearch.style.display = query ? 'block' : 'none';
  Array.from(dom.grid.children).forEach(wrap => {
    const title = wrap.querySelector('.title').textContent.toLowerCase();
    wrap.style.display = title.includes(query) ? '' : 'none';
  });
});

dom.clearSearch.addEventListener('click', () => {
  dom.search.value = '';
  dom.search.dispatchEvent(new Event('input'));
});

dom.buttons.compare.addEventListener('click', () => setCompareMode(true));
dom.buttons.cancel.addEventListener('click', () => setCompareMode(false));
dom.buttons.confirm.addEventListener('click', showCompareModal);

dom.toggleView.addEventListener('click', () => {
  state.currentView = state.currentView === 'grid' ? 'list' : 'grid';
  applyViewMode();
});

dom.modal.addEventListener('click', e => { if (e.target === dom.modal) closeModal(); });

const themeToggle = document.getElementById('theme-toggle');
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  themeToggle.checked = true;
}
themeToggle.addEventListener('change', () => {
  document.body.classList.toggle('dark', themeToggle.checked);
  localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
});

const scrollBtn = document.getElementById('scroll-to-top');
window.addEventListener('scroll', () => scrollBtn.classList.toggle('visible', window.scrollY > 300));
scrollBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

// Init
buildGrid();
dom.criterion.value = 'rating';
flipSortByCriterion('rating');

</script>
</body>
</html>